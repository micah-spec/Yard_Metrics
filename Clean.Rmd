---
title: "Clean"
author: "Micah Turner"
date: "2023-09-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This document is intended to import the data and clean it for downstream analytics and visualization. 

# Load Libraries
```{r}
library(tidyverse)
library(data.table)
library(knitr)
```

# Read CSV
```{r}
dat <- read.csv("2023_02_summary.csv", header=FALSE)
```

# Tidy Data
```{r}
# Remove metadata about csv (e.g. export date/time)        

        ## Create Vector of Employee IDs
        employee_ID <- pull(dat,V2)
        employee_ID <- unique(employee_ID)
        employee_ID <- employee_ID[3:length(employee_ID)]

        ## Remove rows below Employee_Id in data
        tempVar1 <- length(employee_ID)+3
        tempVar2 <- nrow(dat)
        dat <- dat[-c(tempVar1:tempVar2),]

# Remove problematic punctuation and symbols
        
        ## Remove commas, which if present returns NA upon conversion to numeric class (e.g 1,215 to 1215)
        tempVar3 <- c(3:length(dat))
        dat[tempVar3] <- lapply(dat[tempVar3], gsub, pattern =",", replacement="")

        ## Remove % symbols, which if present returns NA upon conversion to numeric class (e.g. 98% = 98)
        dat[tempVar3] <- lapply(dat[tempVar3], gsub, pattern ="%", replacement="")


# Extract completed moves metric from data
        cms1 <- dat[, dat[2, ] == "Completed Moves"]
        cms2 <- dat[, c(2,length(dat)-3)]
        cms3 <- cbind(cms2, cms1)

        ## Make the date row the header
        cms4 <- cms3
        colnames(cms4) <- cms3[1, ]

        ## Label the Employee ID column
        colnames(cms4)[1] <- "Employee_ID"

        ## Label the metric column 
        colnames(cms4)[2] <- "Moves"
        
        ## Remove first 2 rows
                cms4 = cms4[-c(1:2),]
        
        ## Change the data class from character to numeric
        c1 <- c(2:length(cms4))
        cms4[ ,c1] <- apply(cms4[ ,c1], 2, function(x) as.numeric(as.character(x)))
        
        ## Pivot
        cms5 <- cms4[,-2] %>%
                pivot_longer(
                        cols = !"Employee_ID",
                        names_to = "Date",
                        values_to = "Moves",
                )
        ## Convert Date column to date data-class
        cms5$Date <- mdy(cms5$Date)
        cms5 <- as.data.frame(cms5)
        
# Extract Hours Worked metric from data
        hrw1 <- dat[, dat[2, ] == "Hours Worked"]
        hrw2 <- dat[, c(2,length(dat)-3)]
        hrw3 <- cbind(hrw2, hrw1)

        ## Make the date row the header
        hrw4 <- hrw3
        colnames(hrw4) <- hrw3[1, ]

        ## Label the Employee ID column
        colnames(hrw4)[1] <- "Employee_ID"

        ## Label the metric column 
        colnames(hrw4)[2] <- "Hours"
        
        ## Remove first 2 rows
                hrw4 = hrw4[-c(1:2),]
        
        ## Change the data class from character to numeric
        hrw4[ ,c1] <- apply(hrw4[ ,c1], 2, function(x) as.numeric(as.character(x)))
        
        ## Pivot
        hrw5 <- hrw4[,-2] %>%
                pivot_longer(
                        cols = !"Employee_ID",
                        names_to = "Date",
                        values_to = "Hours",
                )
        ## Convert Date column to date data-class
        hrw5$Date <- mdy(hrw5$Date)
        hrw5 <- as.data.frame(hrw5)

# Extract Moves per Hour metric from data
        mph1 <- dat[, dat[2, ] == "MPH"]
        mph2 <- dat[, c(2,length(dat)-3)]
        mph3 <- cbind(mph2, mph1)

        ## Make the date row the header
        mph4 <- mph3
        colnames(mph4) <- mph3[1, ]

        ## Label the Employee ID column
        colnames(mph4)[1] <- "Employee_ID"

        ## Label the metric column 
        colnames(mph4)[2] <- "MPH"
        
        ## Remove first 2 rows
                mph4 = mph4[-c(1:2),]
        
        ## Change the data class from character to numeric
        mph4[ ,c1] <- apply(mph4[ ,c1], 2, function(x) as.numeric(as.character(x)))
        
        ## Pivot
        mph5 <- mph4[,-2] %>%
                pivot_longer(
                        cols = !"Employee_ID",
                        names_to = "Date",
                        values_to = "MPH",
                )
        ## Convert Date column to date data-class
        mph5$Date <- mdy(mph5$Date)
        mph5 <- as.data.frame(mph5)

                
 # Extract On-Time Percent metric from data
        otp1 <- dat[, dat[2, ] == "On-Time Moves "]
  
                otp2 <- dat[, c(2,length(dat)-3)]
        otp3 <- cbind(otp2, otp1)

        ## Make the date row the header
        otp4 <- otp3
        colnames(otp4) <- otp3[1, ]

        ## Label the Employee ID column
        colnames(otp4)[1] <- "Employee_ID"

        ## Label the metric column 
        colnames(otp4)[2] <- "Percent"
        
        ## Remove first 2 rows
                otp4 = otp4[-c(1:2),]
                
        ## Change the data class from character to numeric
        otp4[ ,c1] <- apply(otp4[ ,c1], 2, function(x) as.numeric(as.character(x)))
                
        ## Pivot
        otp5 <- otp4[,-2] %>%
                pivot_longer(
                        cols = !"Employee_ID",
                        names_to = "Date",
                        values_to = "Percent",
                )
        ## Convert Date column to date data-class
        otp5$Date <- mdy(otp5$Date)
        otp5 <- as.data.frame(otp5)  
        
# Merge Metrics
       v1 <- merge(x = cms5, y = hrw5)
       v2 <- merge(x = v1, y = mph5)
       v3 <- merge(x = v2, y = otp5) 
```

# Add Calculated Columns
```{r}
# Remove NA values
        v4 <- v3 %>% filter(!is.na(MPH))

# Create new column with quantity of On Time Moves
       v5 <- v4 %>% mutate(On_Time = round(Moves * Percent/100,digits = 0))

# Create new column with quantity of Late Moves
        v6 <- v5 %>% mutate(Late = Moves - On_Time)
        
# Create new column with quantity of additional moves needed to hit 5 moves/hr target 
       v7 <- v6 %>% mutate(Target_Moves = pmax(5*Hours-Moves,0))
        
# Create new column with the min quantity of additional On Time moves needed to hit 5 moves/hr target required to meet 78% on time threshold 
       v8 <- v7 %>% mutate(Min_On_Time = pmax(round(.78*(Moves+Target_Moves)-On_Time,digits=0),0))
       
# Create new column with difference between Min_On_Time and Target_Moves
       v9 <- v8 %>% mutate(OK_Late = pmax(Target_Moves - Min_On_Time,0))
              
View(v9)


```
